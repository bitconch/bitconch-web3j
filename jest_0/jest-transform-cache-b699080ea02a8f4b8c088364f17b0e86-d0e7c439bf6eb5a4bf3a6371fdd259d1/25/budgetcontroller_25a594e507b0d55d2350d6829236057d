f3df44d82ff17cc63acc072837078726
"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.BudgetController = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var BufferLayout = _interopRequireWildcard(require("buffer-layout"));

var _transactionController = require("./transaction-controller");

var _pubkey = require("./pubkey");

var _systemController = require("./system-controller");

/**
 * @private
 */
function serializePayment(payment) {
  var toData = payment.to.toBuffer();
  var data = Buffer.alloc(8 + toData.length);
  data.writeUInt32LE(payment.amount, 0);
  toData.copy(data, 8);
  return data;
}
/**
 * @private
 */


function serializeTime(when) {
  var data = Buffer.alloc(8 + 20);
  data.writeUInt32LE(20, 0); // size of timestamp as u64

  function iso(date) {
    function pad(number) {
      if (number < 10) {
        return '0' + number;
      }

      return number;
    }

    return date.getUTCFullYear() + '-' + pad(date.getUTCMonth() + 1) + '-' + pad(date.getUTCDate()) + 'T' + pad(date.getUTCHours()) + ':' + pad(date.getUTCMinutes()) + ':' + pad(date.getUTCSeconds()) + 'Z';
  }

  data.write(iso(when), 8);
  return data;
}
/**
 * @private
 */


function serializeCond(condition) {
  switch (condition.type) {
    case 'timestamp':
      {
        var date = serializeTime(condition.when);
        var from = condition.from.toBuffer();
        var data = Buffer.alloc(4 + date.length + from.length);
        data.writeUInt32LE(0, 0); // Condition enum = Timestamp

        date.copy(data, 4);
        from.copy(data, 4 + date.length);
        return data;
      }

    case 'signature':
      {
        var _from = condition.from.toBuffer();

        var _data = Buffer.alloc(4 + _from.length);

        _data.writeUInt32LE(1, 0); // Condition enum = Signature


        _from.copy(_data, 4);

        return _data;
      }

    default:
      throw new Error("Unknown condition type: ".concat(condition.type));
  }
}
/**
 * Factory class for transactions to interact with the Budget program
 */


var BudgetController =
/*#__PURE__*/
function () {
  function BudgetController() {
    (0, _classCallCheck2["default"])(this, BudgetController);
  }

  (0, _createClass2["default"])(BudgetController, null, [{
    key: "datetimeCond",

    /**
     * Creates a timestamp condition
     */
    value: function datetimeCond(from, when) {
      return {
        type: 'timestamp',
        from: from,
        when: when
      };
    }
    /**
     * Creates a signature condition
     */

  }, {
    key: "signatureCond",
    value: function signatureCond(from) {
      return {
        type: 'signature',
        from: from
      };
    }
    /**
     * Generates a transaction that transfers difs once any of the conditions are met
     */

  }, {
    key: "pay",
    value: function pay(from, program, to, amount) {
      var data = Buffer.alloc(1024);
      var pos = 0;
      data.writeUInt32LE(0, pos); // NewBudget instruction

      pos += 4;

      for (var _len = arguments.length, conditions = new Array(_len > 4 ? _len - 4 : 0), _key = 4; _key < _len; _key++) {
        conditions[_key - 4] = arguments[_key];
      }

      switch (conditions.length) {
        case 0:
          {
            data.writeUInt32LE(0, pos); // BudgetExpr enum = Pay

            pos += 4;
            {
              var payment = serializePayment({
                amount: amount,
                to: to
              });
              payment.copy(data, pos);
              pos += payment.length;
            }
            var trimmedData = data.slice(0, pos);

            var transaction = _systemController.SystemController.createNewAccount(from, program, amount, trimmedData.length, this.controllerId);

            return transaction.add({
              keys: [{
                pubkey: to,
                isSigner: false,
                isDebitable: false
              }, {
                pubkey: program,
                isSigner: false,
                isDebitable: true
              }],
              controllerId: this.controllerId,
              data: trimmedData
            });
          }

        case 1:
          {
            data.writeUInt32LE(1, pos); // BudgetExpr enum = After

            pos += 4;
            {
              var condition = conditions[0];
              var conditionData = serializeCond(condition);
              conditionData.copy(data, pos);
              pos += conditionData.length;
              data.writeUInt32LE(0, pos); // BudgetExpr enum = Pay

              pos += 4;
              var paymentData = serializePayment({
                amount: amount,
                to: to
              });
              paymentData.copy(data, pos);
              pos += paymentData.length;
            }

            var _trimmedData = data.slice(0, pos);

            var _transaction = _systemController.SystemController.createNewAccount(from, program, amount, _trimmedData.length, this.controllerId);

            return _transaction.add({
              keys: [{
                pubkey: program,
                isSigner: false,
                isDebitable: true
              }],
              controllerId: this.controllerId,
              data: _trimmedData
            });
          }

        case 2:
          {
            data.writeUInt32LE(2, pos); // BudgetExpr enum = Or

            pos += 4;

            for (var _i = 0, _conditions = conditions; _i < _conditions.length; _i++) {
              var _condition = _conditions[_i];

              var _conditionData = serializeCond(_condition);

              _conditionData.copy(data, pos);

              pos += _conditionData.length;
              data.writeUInt32LE(0, pos); // BudgetExpr enum = Pay

              pos += 4;

              var _paymentData = serializePayment({
                amount: amount,
                to: to
              });

              _paymentData.copy(data, pos);

              pos += _paymentData.length;
            }

            var _trimmedData2 = data.slice(0, pos);

            var _transaction2 = _systemController.SystemController.createNewAccount(from, program, amount, _trimmedData2.length, this.controllerId);

            return _transaction2.add({
              keys: [{
                pubkey: program,
                isSigner: false,
                isDebitable: true
              }],
              controllerId: this.controllerId,
              data: _trimmedData2
            });
          }

        default:
          throw new Error("A maximum of two conditions are support: ".concat(conditions.length, " provided"));
      }
    }
    /**
     * Generates a transaction that transfers difs once both conditions are met
     */

  }, {
    key: "payOnAll",
    value: function payOnAll(from, program, to, amount, condition1, condition2) {
      var data = Buffer.alloc(1024);
      var pos = 0;
      data.writeUInt32LE(0, pos); // NewBudget instruction

      pos += 4;
      data.writeUInt32LE(3, pos); // BudgetExpr enum = And

      pos += 4;

      for (var _i2 = 0, _arr = [condition1, condition2]; _i2 < _arr.length; _i2++) {
        var condition = _arr[_i2];
        var conditionData = serializeCond(condition);
        conditionData.copy(data, pos);
        pos += conditionData.length;
      }

      data.writeUInt32LE(0, pos); // BudgetExpr enum = Pay

      pos += 4;
      var paymentData = serializePayment({
        amount: amount,
        to: to
      });
      paymentData.copy(data, pos);
      pos += paymentData.length;
      var trimmedData = data.slice(0, pos);

      var transaction = _systemController.SystemController.createNewAccount(from, program, amount, trimmedData.length, this.controllerId);

      return transaction.add({
        keys: [{
          pubkey: program,
          isSigner: false,
          isDebitable: true
        }],
        controllerId: this.controllerId,
        data: trimmedData
      });
    }
    /**
     * Generates a transaction that applies a timestamp, which could enable a
     * pending payment to proceed.
     */

  }, {
    key: "sealWithDatetime",
    value: function sealWithDatetime(from, program, to, when) {
      var whenData = serializeTime(when);
      var data = Buffer.alloc(4 + whenData.length);
      data.writeUInt32LE(1, 0); // ApplyTimestamp instruction

      whenData.copy(data, 4);
      return new _transactionController.Transaction().add({
        keys: [{
          pubkey: from,
          isSigner: true,
          isDebitable: true
        }, {
          pubkey: program,
          isSigner: false,
          isDebitable: true
        }, {
          pubkey: to,
          isSigner: false,
          isDebitable: false
        }],
        controllerId: this.controllerId,
        data: data
      });
    }
    /**
     * Generates a transaction that applies a signature, which could enable a
     * pending payment to proceed.
     */

  }, {
    key: "sealWithSignature",
    value: function sealWithSignature(from, program, to) {
      var dataLayout = BufferLayout.struct([BufferLayout.u32('instruction')]);
      var data = Buffer.alloc(dataLayout.span);
      dataLayout.encode({
        instruction: 2 // ApplySignature instruction

      }, data);
      return new _transactionController.Transaction().add({
        keys: [{
          pubkey: from,
          isSigner: true,
          isDebitable: true
        }, {
          pubkey: program,
          isSigner: false,
          isDebitable: true
        }, {
          pubkey: to,
          isSigner: false,
          isDebitable: false
        }],
        controllerId: this.controllerId,
        data: data
      });
    }
  }, {
    key: "controllerId",

    /**
     * Public key that identifies the Budget program
     */
    get: function get() {
      return new _pubkey.PubKey('Budget1111111111111111111111111111111111111');
    }
    /**
     * The amount of space this program requires
     */

  }, {
    key: "size",
    get: function get() {
      return 128;
    }
  }]);
  return BudgetController;
}();

exports.BudgetController = BudgetController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJ1ZGdldC1jb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbInNlcmlhbGl6ZVBheW1lbnQiLCJwYXltZW50IiwidG9EYXRhIiwidG8iLCJ0b0J1ZmZlciIsImRhdGEiLCJCdWZmZXIiLCJhbGxvYyIsImxlbmd0aCIsIndyaXRlVUludDMyTEUiLCJhbW91bnQiLCJjb3B5Iiwic2VyaWFsaXplVGltZSIsIndoZW4iLCJpc28iLCJkYXRlIiwicGFkIiwibnVtYmVyIiwiZ2V0VVRDRnVsbFllYXIiLCJnZXRVVENNb250aCIsImdldFVUQ0RhdGUiLCJnZXRVVENIb3VycyIsImdldFVUQ01pbnV0ZXMiLCJnZXRVVENTZWNvbmRzIiwid3JpdGUiLCJzZXJpYWxpemVDb25kIiwiY29uZGl0aW9uIiwidHlwZSIsImZyb20iLCJFcnJvciIsIkJ1ZGdldENvbnRyb2xsZXIiLCJwcm9ncmFtIiwicG9zIiwiY29uZGl0aW9ucyIsInRyaW1tZWREYXRhIiwic2xpY2UiLCJ0cmFuc2FjdGlvbiIsIlN5c3RlbUNvbnRyb2xsZXIiLCJjcmVhdGVOZXdBY2NvdW50IiwiY29udHJvbGxlcklkIiwiYWRkIiwia2V5cyIsInB1YmtleSIsImlzU2lnbmVyIiwiaXNEZWJpdGFibGUiLCJjb25kaXRpb25EYXRhIiwicGF5bWVudERhdGEiLCJjb25kaXRpb24xIiwiY29uZGl0aW9uMiIsIndoZW5EYXRhIiwiVHJhbnNhY3Rpb24iLCJkYXRhTGF5b3V0IiwiQnVmZmVyTGF5b3V0Iiwic3RydWN0IiwidTMyIiwic3BhbiIsImVuY29kZSIsImluc3RydWN0aW9uIiwiUHViS2V5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFFQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFpREE7OztBQUdBLFNBQVNBLGdCQUFULENBQTBCQyxPQUExQixFQUFvRDtBQUNsRCxNQUFNQyxNQUFNLEdBQUdELE9BQU8sQ0FBQ0UsRUFBUixDQUFXQyxRQUFYLEVBQWY7QUFDQSxNQUFNQyxJQUFJLEdBQUdDLE1BQU0s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SkE7QUFQMkIsT0FBdEIsQ0FBUDtBQVNEOzs7O0FBblFEOzs7d0JBR2tDO0FBQ2hDLGFBQU8sSUFBSXFELGNBQUosQ0FBVyw2Q0FBWCxDQUFQO0FBQ0Q7QUFFRDs7Ozs7O3dCQUcwQjtBQUN4QixhQUFPLEdBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCAqIGFzIEJ1ZmZlckxheW91dCBmcm9tICdidWZmZXItbGF5b3V0JztcblxuaW1wb3J0IHtUcmFuc2FjdGlvbn0gZnJvbSAnLi90cmFuc2FjdGlvbi1jb250cm9sbGVyJztcbmltcG9ydCB7UHViS2V5fSBmcm9tICcuL3B1YmtleSc7XG5pbXBvcnQge1N5c3RlbUNvbnRyb2xsZXJ9IGZyb20gJy4vc3lzdGVtLWNvbnRyb2xsZXInO1xuXG4vKipcbiAqIFJlcHJlc2VudHMgYSBjb25kaXRpb24gdGhhdCBpcyBtZXQgYnkgZXhlY3V0aW5nIGEgYHNlYWxXaXRoU2lnbmF0dXJlKClgXG4gKiB0cmFuc2FjdGlvblxuICpcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFNpZ25hdHVyZUNvbmRcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB0eXBlIE11c3QgZXF1YWwgdGhlIHN0cmluZyAndGltZXN0YW1wJ1xuICogQHByb3BlcnR5IHtQdWJLZXl9IGZyb20gUHVibGljIGtleSBmcm9tIHdoaWNoIGBzZWFsV2l0aFNpZ25hdHVyZSgpYCB3aWxsIGJlIGFjY2VwdGVkIGZyb21cbiAqL1xuZXhwb3J0IHR5cGUgU2lnbmF0dXJlQ29uZCA9IHtcbiAgdHlwZTogJ3NpZ25hdHVyZScsXG4gIGZyb206IFB1YktleSxcbn07XG5cbi8qKlxuICogUmVwcmVzZW50cyBhIGNvbmRpdGlvbiB0aGF0IGlzIG1ldCBieSBleGVjdXRpbmcgYSBgc2VhbFdpdGhEYXRldGltZSgpYFxuICogdHJhbnNhY3Rpb25cbiAqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBUaW1lc3RhbXBDb25kXG4gKiBAcHJvcGVydHkge3N0cmluZ30gdHlwZSBNdXN0IGVxdWFsIHRoZSBzdHJpbmcgJ3RpbWVzdGFtcCdcbiAqIEBwcm9wZXJ0eSB7UHViS2V5fSBmcm9tIFB1YmxpYyBrZXkgZnJvbSB3aGljaCBgc2VhbFdpdGhEYXRldGltZSgpYCB3aWxsIGJlIGFjY2VwdGVkIGZyb21cbiAqIEBwcm9wZXJ0eSB7RGF0ZX0gd2hlbiBUaGUgdGltZXN0YW1wIHRoYXQgd2FzIG9ic2VydmVkXG4gKi9cbmV4cG9ydCB0eXBlIFRpbWVzdGFtcENvbmQgPSB7XG4gIHR5cGU6ICd0aW1lc3RhbXAnLFxuICBmcm9tOiBQdWJLZXksXG4gIHdoZW46IERhdGUsXG59O1xuXG4vKipcbiAqIFJlcHJlc2VudHMgYSBwYXltZW50IHRvIGEgZ2l2ZW4gcHVibGljIGtleVxuICpcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFBheW1lbnRcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbW91bnQgTnVtYmVyIG9mIGRpZnNcbiAqIEBwcm9wZXJ0eSB7UHViS2V5fSB0byBQdWJsaWMga2V5IG9mIHRoZSByZWNpcGllbnRcbiAqL1xuZXhwb3J0IHR5cGUgUGF5bWVudCA9IHtcbiAgYW1vdW50OiBudW1iZXIsXG4gIHRvOiBQdWJLZXksXG59O1xuXG4vKipcbiAqIEEgY29uZGl0aW9uIHRoYXQgY2FuIHVubG9jayBhIHBheW1lbnRcbiAqXG4gKiBAdHlwZWRlZiB7U2lnbmF0dXJlQ29uZHxUaW1lc3RhbXBDb25kfSBCdWRnZXRDb25kXG4gKi9cbmV4cG9ydCB0eXBlIEJ1ZGdldENvbmQgPSBTaWduYXR1cmVDb25kIHwgVGltZXN0YW1wQ29uZDtcblxuLyoqXG4gKiBAcHJpdmF0ZVxuICovXG5mdW5jdGlvbiBzZXJpYWxpemVQYXltZW50KHBheW1lbnQ6IFBheW1lbnQpOiBCdWZmZXIge1xuICBjb25zdCB0b0RhdGEgPSBwYXltZW50LnRvLnRvQnVmZmVyKCk7XG4gIGNvbnN0IGRhdGEgPSBCdWZmZXIuYWxsb2MoOCArIHRvRGF0YS5sZW5ndGgpO1xuICBkYXRhLndyaXRlVUludDMyTEUocGF5bWVudC5hbW91bnQsIDApO1xuICB0b0RhdGEuY29weShkYXRhLCA4KTtcbiAgcmV0dXJuIGRhdGE7XG59XG5cbi8qKlxuICogQHByaXZhdGVcbiAqL1xuZnVuY3Rpb24gc2VyaWFsaXplVGltZSh3aGVuOiBEYXRlKTogQnVmZmVyIHtcbiAgY29uc3QgZGF0YSA9IEJ1ZmZlci5hbGxvYyg4ICsgMjApO1xuICBkYXRhLndyaXRlVUludDMyTEUoMjAsIDApOyAvLyBzaXplIG9mIHRpbWVzdGFtcCBhcyB1NjRcblxuICBmdW5jdGlvbiBpc28oZGF0ZSkge1xuICAgIGZ1bmN0aW9uIHBhZChudW1iZXIpIHtcbiAgICAgIGlmIChudW1iZXIgPCAxMCkge1xuICAgICAgICByZXR1cm4gJzAnICsgbnVtYmVyO1xuICAgICAgfVxuICAgICAgcmV0dXJuIG51bWJlcjtcbiAgICB9XG5cbiAgICByZXR1cm4gKFxuICAgICAgZGF0ZS5nZXRVVENGdWxsWWVhcigpICtcbiAgICAgICctJyArXG4gICAgICBwYWQoZGF0ZS5nZXRVVENNb250aCgpICsgMSkgK1xuICAgICAgJy0nICtcbiAgICAgIHBhZChkYXRlLmdldFVUQ0RhdGUoKSkgK1xuICAgICAgJ1QnICtcbiAgICAgIHBhZChkYXRlLmdldFVUQ0hvdXJzKCkpICtcbiAgICAgICc6JyArXG4gICAgICBwYWQoZGF0ZS5nZXRVVENNaW51dGVzKCkpICtcbiAgICAgICc6JyArXG4gICAgICBwYWQoZGF0ZS5nZXRVVENTZWNvbmRzKCkpICtcbiAgICAgICdaJ1xuICAgICk7XG4gIH1cbiAgZGF0YS53cml0ZShpc28od2hlbiksIDgpO1xuICByZXR1cm4gZGF0YTtcbn1cblxuLyoqXG4gKiBAcHJpdmF0ZVxuICovXG5mdW5jdGlvbiBzZXJpYWxpemVDb25kKGNvbmRpdGlvbjogQnVkZ2V0Q29uZCkge1xuICBzd2l0Y2ggKGNvbmRpdGlvbi50eXBlKSB7XG4gICAgY2FzZSAndGltZXN0YW1wJzoge1xuICAgICAgY29uc3QgZGF0ZSA9IHNlcmlhbGl6ZVRpbWUoY29uZGl0aW9uLndoZW4pO1xuICAgICAgY29uc3QgZnJvbSA9IGNvbmRpdGlvbi5mcm9tLnRvQnVmZmVyKCk7XG5cbiAgICAgIGNvbnN0IGRhdGEgPSBCdWZmZXIuYWxsb2MoNCArIGRhdGUubGVuZ3RoICsgZnJvbS5sZW5ndGgpO1xuICAgICAgZGF0YS53cml0ZVVJbnQzMkxFKDAsIDApOyAvLyBDb25kaXRpb24gZW51bSA9IFRpbWVzdGFtcFxuICAgICAgZGF0ZS5jb3B5KGRhdGEsIDQpO1xuICAgICAgZnJvbS5jb3B5KGRhdGEsIDQgKyBkYXRlLmxlbmd0aCk7XG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG4gICAgY2FzZSAnc2lnbmF0dXJlJzoge1xuICAgICAgY29uc3QgZnJvbSA9IGNvbmRpdGlvbi5mcm9tLnRvQnVmZmVyKCk7XG4gICAgICBjb25zdCBkYXRhID0gQnVmZmVyLmFsbG9jKDQgKyBmcm9tLmxlbmd0aCk7XG4gICAgICBkYXRhLndyaXRlVUludDMyTEUoMSwgMCk7IC8vIENvbmRpdGlvbiBlbnVtID0gU2lnbmF0dXJlXG4gICAgICBmcm9tLmNvcHkoZGF0YSwgNCk7XG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG4gICAgZGVmYXVsdDpcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBjb25kaXRpb24gdHlwZTogJHtjb25kaXRpb24udHlwZX1gKTtcbiAgfVxufVxuXG4vKipcbiAqIEZhY3RvcnkgY2xhc3MgZm9yIHRyYW5zYWN0aW9ucyB0byBpbnRlcmFjdCB3aXRoIHRoZSBCdWRnZXQgcHJvZ3JhbVxuICovXG5leHBvcnQgY2xhc3MgQnVkZ2V0Q29udHJvbGxlciB7XG4gIC8qKlxuICAgKiBQdWJsaWMga2V5IHRoYXQgaWRlbnRpZmllcyB0aGUgQnVkZ2V0IHByb2dyYW1cbiAgICovXG4gIHN0YXRpYyBnZXQgY29udHJvbGxlcklkKCk6IFB1YktleSB7XG4gICAgcmV0dXJuIG5ldyBQdWJLZXkoJ0J1ZGdldDExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTEnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgYW1vdW50IG9mIHNwYWNlIHRoaXMgcHJvZ3JhbSByZXF1aXJlc1xuICAgKi9cbiAgc3RhdGljIGdldCBzaXplKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIDEyODtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGEgdGltZXN0YW1wIGNvbmRpdGlvblxuICAgKi9cbiAgc3RhdGljIGRhdGV0aW1lQ29uZChmcm9tOiBQdWJLZXksIHdoZW46IERhdGUpOiBUaW1lc3RhbXBDb25kIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogJ3RpbWVzdGFtcCcsXG4gICAgICBmcm9tLFxuICAgICAgd2hlbixcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBzaWduYXR1cmUgY29uZGl0aW9uXG4gICAqL1xuICBzdGF0aWMgc2lnbmF0dXJlQ29uZChmcm9tOiBQdWJLZXkpOiBTaWduYXR1cmVDb25kIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogJ3NpZ25hdHVyZScsXG4gICAgICBmcm9tLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGVzIGEgdHJhbnNhY3Rpb24gdGhhdCB0cmFuc2ZlcnMgZGlmcyBvbmNlIGFueSBvZiB0aGUgY29uZGl0aW9ucyBhcmUgbWV0XG4gICAqL1xuICBzdGF0aWMgcGF5KFxuICAgIGZyb206IFB1YktleSxcbiAgICBwcm9ncmFtOiBQdWJLZXksXG4gICAgdG86IFB1YktleSxcbiAgICBhbW91bnQ6IG51bWJlcixcbiAgICAuLi5jb25kaXRpb25zOiBBcnJheTxCdWRnZXRDb25kPlxuICApOiBUcmFuc2FjdGlvbiB7XG4gICAgY29uc3QgZGF0YSA9IEJ1ZmZlci5hbGxvYygxMDI0KTtcbiAgICBsZXQgcG9zID0gMDtcbiAgICBkYXRhLndyaXRlVUludDMyTEUoMCwgcG9zKTsgLy8gTmV3QnVkZ2V0IGluc3RydWN0aW9uXG4gICAgcG9zICs9IDQ7XG5cbiAgICBzd2l0Y2ggKGNvbmRpdGlvbnMubGVuZ3RoKSB7XG4gICAgICBjYXNlIDA6IHtcbiAgICAgICAgZGF0YS53cml0ZVVJbnQzMkxFKDAsIHBvcyk7IC8vIEJ1ZGdldEV4cHIgZW51bSA9IFBheVxuICAgICAgICBwb3MgKz0gNDtcblxuICAgICAgICB7XG4gICAgICAgICAgY29uc3QgcGF5bWVudCA9IHNlcmlhbGl6ZVBheW1lbnQoe2Ftb3VudCwgdG99KTtcbiAgICAgICAgICBwYXltZW50LmNvcHkoZGF0YSwgcG9zKTtcbiAgICAgICAgICBwb3MgKz0gcGF5bWVudC5sZW5ndGg7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdHJpbW1lZERhdGEgPSBkYXRhLnNsaWNlKDAsIHBvcyk7XG5cbiAgICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSBTeXN0ZW1Db250cm9sbGVyLmNyZWF0ZU5ld0FjY291bnQoXG4gICAgICAgICAgZnJvbSxcbiAgICAgICAgICBwcm9ncmFtLFxuICAgICAgICAgIGFtb3VudCxcbiAgICAgICAgICB0cmltbWVkRGF0YS5sZW5ndGgsXG4gICAgICAgICAgdGhpcy5jb250cm9sbGVySWQsXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIHRyYW5zYWN0aW9uLmFkZCh7XG4gICAgICAgICAga2V5czogW1xuICAgICAgICAgICAge3B1YmtleTogdG8sIGlzU2lnbmVyOiBmYWxzZSwgaXNEZWJpdGFibGU6IGZhbHNlfSxcbiAgICAgICAgICAgIHtwdWJrZXk6IHByb2dyYW0sIGlzU2lnbmVyOiBmYWxzZSwgaXNEZWJpdGFibGU6IHRydWV9LFxuICAgICAgICAgIF0sXG4gICAgICAgICAgY29udHJvbGxlcklkOiB0aGlzLmNvbnRyb2xsZXJJZCxcbiAgICAgICAgICBkYXRhOiB0cmltbWVkRGF0YSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBjYXNlIDE6IHtcbiAgICAgICAgZGF0YS53cml0ZVVJbnQzMkxFKDEsIHBvcyk7IC8vIEJ1ZGdldEV4cHIgZW51bSA9IEFmdGVyXG4gICAgICAgIHBvcyArPSA0O1xuICAgICAgICB7XG4gICAgICAgICAgY29uc3QgY29uZGl0aW9uID0gY29uZGl0aW9uc1swXTtcblxuICAgICAgICAgIGNvbnN0IGNvbmRpdGlvbkRhdGEgPSBzZXJpYWxpemVDb25kKGNvbmRpdGlvbik7XG4gICAgICAgICAgY29uZGl0aW9uRGF0YS5jb3B5KGRhdGEsIHBvcyk7XG4gICAgICAgICAgcG9zICs9IGNvbmRpdGlvbkRhdGEubGVuZ3RoO1xuXG4gICAgICAgICAgZGF0YS53cml0ZVVJbnQzMkxFKDAsIHBvcyk7IC8vIEJ1ZGdldEV4cHIgZW51bSA9IFBheVxuICAgICAgICAgIHBvcyArPSA0O1xuXG4gICAgICAgICAgY29uc3QgcGF5bWVudERhdGEgPSBzZXJpYWxpemVQYXltZW50KHthbW91bnQsIHRvfSk7XG4gICAgICAgICAgcGF5bWVudERhdGEuY29weShkYXRhLCBwb3MpO1xuICAgICAgICAgIHBvcyArPSBwYXltZW50RGF0YS5sZW5ndGg7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdHJpbW1lZERhdGEgPSBkYXRhLnNsaWNlKDAsIHBvcyk7XG5cbiAgICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSBTeXN0ZW1Db250cm9sbGVyLmNyZWF0ZU5ld0FjY291bnQoXG4gICAgICAgICAgZnJvbSxcbiAgICAgICAgICBwcm9ncmFtLFxuICAgICAgICAgIGFtb3VudCxcbiAgICAgICAgICB0cmltbWVkRGF0YS5sZW5ndGgsXG4gICAgICAgICAgdGhpcy5jb250cm9sbGVySWQsXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIHRyYW5zYWN0aW9uLmFkZCh7XG4gICAgICAgICAga2V5czogW3twdWJrZXk6IHByb2dyYW0sIGlzU2lnbmVyOiBmYWxzZSwgaXNEZWJpdGFibGU6IHRydWV9XSxcbiAgICAgICAgICBjb250cm9sbGVySWQ6IHRoaXMuY29udHJvbGxlcklkLFxuICAgICAgICAgIGRhdGE6IHRyaW1tZWREYXRhLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY2FzZSAyOiB7XG4gICAgICAgIGRhdGEud3JpdGVVSW50MzJMRSgyLCBwb3MpOyAvLyBCdWRnZXRFeHByIGVudW0gPSBPclxuICAgICAgICBwb3MgKz0gNDtcblxuICAgICAgICBmb3IgKGxldCBjb25kaXRpb24gb2YgY29uZGl0aW9ucykge1xuICAgICAgICAgIGNvbnN0IGNvbmRpdGlvbkRhdGEgPSBzZXJpYWxpemVDb25kKGNvbmRpdGlvbik7XG4gICAgICAgICAgY29uZGl0aW9uRGF0YS5jb3B5KGRhdGEsIHBvcyk7XG4gICAgICAgICAgcG9zICs9IGNvbmRpdGlvbkRhdGEubGVuZ3RoO1xuXG4gICAgICAgICAgZGF0YS53cml0ZVVJbnQzMkxFKDAsIHBvcyk7IC8vIEJ1ZGdldEV4cHIgZW51bSA9IFBheVxuICAgICAgICAgIHBvcyArPSA0O1xuXG4gICAgICAgICAgY29uc3QgcGF5bWVudERhdGEgPSBzZXJpYWxpemVQYXltZW50KHthbW91bnQsIHRvfSk7XG4gICAgICAgICAgcGF5bWVudERhdGEuY29weShkYXRhLCBwb3MpO1xuICAgICAgICAgIHBvcyArPSBwYXltZW50RGF0YS5sZW5ndGg7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdHJpbW1lZERhdGEgPSBkYXRhLnNsaWNlKDAsIHBvcyk7XG5cbiAgICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSBTeXN0ZW1Db250cm9sbGVyLmNyZWF0ZU5ld0FjY291bnQoXG4gICAgICAgICAgZnJvbSxcbiAgICAgICAgICBwcm9ncmFtLFxuICAgICAgICAgIGFtb3VudCxcbiAgICAgICAgICB0cmltbWVkRGF0YS5sZW5ndGgsXG4gICAgICAgICAgdGhpcy5jb250cm9sbGVySWQsXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIHRyYW5zYWN0aW9uLmFkZCh7XG4gICAgICAgICAga2V5czogW3twdWJrZXk6IHByb2dyYW0sIGlzU2lnbmVyOiBmYWxzZSwgaXNEZWJpdGFibGU6IHRydWV9XSxcbiAgICAgICAgICBjb250cm9sbGVySWQ6IHRoaXMuY29udHJvbGxlcklkLFxuICAgICAgICAgIGRhdGE6IHRyaW1tZWREYXRhLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBBIG1heGltdW0gb2YgdHdvIGNvbmRpdGlvbnMgYXJlIHN1cHBvcnQ6ICR7XG4gICAgICAgICAgICBjb25kaXRpb25zLmxlbmd0aFxuICAgICAgICAgIH0gcHJvdmlkZWRgLFxuICAgICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZXMgYSB0cmFuc2FjdGlvbiB0aGF0IHRyYW5zZmVycyBkaWZzIG9uY2UgYm90aCBjb25kaXRpb25zIGFyZSBtZXRcbiAgICovXG4gIHN0YXRpYyBwYXlPbkFsbChcbiAgICBmcm9tOiBQdWJLZXksXG4gICAgcHJvZ3JhbTogUHViS2V5LFxuICAgIHRvOiBQdWJLZXksXG4gICAgYW1vdW50OiBudW1iZXIsXG4gICAgY29uZGl0aW9uMTogQnVkZ2V0Q29uZCxcbiAgICBjb25kaXRpb24yOiBCdWRnZXRDb25kLFxuICApOiBUcmFuc2FjdGlvbiB7XG4gICAgY29uc3QgZGF0YSA9IEJ1ZmZlci5hbGxvYygxMDI0KTtcbiAgICBsZXQgcG9zID0gMDtcbiAgICBkYXRhLndyaXRlVUludDMyTEUoMCwgcG9zKTsgLy8gTmV3QnVkZ2V0IGluc3RydWN0aW9uXG4gICAgcG9zICs9IDQ7XG5cbiAgICBkYXRhLndyaXRlVUludDMyTEUoMywgcG9zKTsgLy8gQnVkZ2V0RXhwciBlbnVtID0gQW5kXG4gICAgcG9zICs9IDQ7XG5cbiAgICBmb3IgKGxldCBjb25kaXRpb24gb2YgW2NvbmRpdGlvbjEsIGNvbmRpdGlvbjJdKSB7XG4gICAgICBjb25zdCBjb25kaXRpb25EYXRhID0gc2VyaWFsaXplQ29uZChjb25kaXRpb24pO1xuICAgICAgY29uZGl0aW9uRGF0YS5jb3B5KGRhdGEsIHBvcyk7XG4gICAgICBwb3MgKz0gY29uZGl0aW9uRGF0YS5sZW5ndGg7XG4gICAgfVxuXG4gICAgZGF0YS53cml0ZVVJbnQzMkxFKDAsIHBvcyk7IC8vIEJ1ZGdldEV4cHIgZW51bSA9IFBheVxuICAgIHBvcyArPSA0O1xuXG4gICAgY29uc3QgcGF5bWVudERhdGEgPSBzZXJpYWxpemVQYXltZW50KHthbW91bnQsIHRvfSk7XG4gICAgcGF5bWVudERhdGEuY29weShkYXRhLCBwb3MpO1xuICAgIHBvcyArPSBwYXltZW50RGF0YS5sZW5ndGg7XG5cbiAgICBjb25zdCB0cmltbWVkRGF0YSA9IGRhdGEuc2xpY2UoMCwgcG9zKTtcblxuICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gU3lzdGVtQ29udHJvbGxlci5jcmVhdGVOZXdBY2NvdW50KFxuICAgICAgZnJvbSxcbiAgICAgIHByb2dyYW0sXG4gICAgICBhbW91bnQsXG4gICAgICB0cmltbWVkRGF0YS5sZW5ndGgsXG4gICAgICB0aGlzLmNvbnRyb2xsZXJJZCxcbiAgICApO1xuXG4gICAgcmV0dXJuIHRyYW5zYWN0aW9uLmFkZCh7XG4gICAgICBrZXlzOiBbe3B1YmtleTogcHJvZ3JhbSwgaXNTaWduZXI6IGZhbHNlLCBpc0RlYml0YWJsZTogdHJ1ZX1dLFxuICAgICAgY29udHJvbGxlcklkOiB0aGlzLmNvbnRyb2xsZXJJZCxcbiAgICAgIGRhdGE6IHRyaW1tZWREYXRhLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlcyBhIHRyYW5zYWN0aW9uIHRoYXQgYXBwbGllcyBhIHRpbWVzdGFtcCwgd2hpY2ggY291bGQgZW5hYmxlIGFcbiAgICogcGVuZGluZyBwYXltZW50IHRvIHByb2NlZWQuXG4gICAqL1xuICBzdGF0aWMgc2VhbFdpdGhEYXRldGltZShcbiAgICBmcm9tOiBQdWJLZXksXG4gICAgcHJvZ3JhbTogUHViS2V5LFxuICAgIHRvOiBQdWJLZXksXG4gICAgd2hlbjogRGF0ZSxcbiAgKTogVHJhbnNhY3Rpb24ge1xuICAgIGNvbnN0IHdoZW5EYXRhID0gc2VyaWFsaXplVGltZSh3aGVuKTtcbiAgICBjb25zdCBkYXRhID0gQnVmZmVyLmFsbG9jKDQgKyB3aGVuRGF0YS5sZW5ndGgpO1xuXG4gICAgZGF0YS53cml0ZVVJbnQzMkxFKDEsIDApOyAvLyBBcHBseVRpbWVzdGFtcCBpbnN0cnVjdGlvblxuICAgIHdoZW5EYXRhLmNvcHkoZGF0YSwgNCk7XG5cbiAgICByZXR1cm4gbmV3IFRyYW5zYWN0aW9uKCkuYWRkKHtcbiAgICAgIGtleXM6IFtcbiAgICAgICAge3B1YmtleTogZnJvbSwgaXNTaWduZXI6IHRydWUsIGlzRGViaXRhYmxlOiB0cnVlfSxcbiAgICAgICAge3B1YmtleTogcHJvZ3JhbSwgaXNTaWduZXI6IGZhbHNlLCBpc0RlYml0YWJsZTogdHJ1ZX0sXG4gICAgICAgIHtwdWJrZXk6IHRvLCBpc1NpZ25lcjogZmFsc2UsIGlzRGViaXRhYmxlOiBmYWxzZX0sXG4gICAgICBdLFxuICAgICAgY29udHJvbGxlcklkOiB0aGlzLmNvbnRyb2xsZXJJZCxcbiAgICAgIGRhdGEsXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGVzIGEgdHJhbnNhY3Rpb24gdGhhdCBhcHBsaWVzIGEgc2lnbmF0dXJlLCB3aGljaCBjb3VsZCBlbmFibGUgYVxuICAgKiBwZW5kaW5nIHBheW1lbnQgdG8gcHJvY2VlZC5cbiAgICovXG4gIHN0YXRpYyBzZWFsV2l0aFNpZ25hdHVyZShcbiAgICBmcm9tOiBQdWJLZXksXG4gICAgcHJvZ3JhbTogUHViS2V5LFxuICAgIHRvOiBQdWJLZXksXG4gICk6IFRyYW5zYWN0aW9uIHtcbiAgICBjb25zdCBkYXRhTGF5b3V0ID0gQnVmZmVyTGF5b3V0LnN0cnVjdChbQnVmZmVyTGF5b3V0LnUzMignaW5zdHJ1Y3Rpb24nKV0pO1xuXG4gICAgY29uc3QgZGF0YSA9IEJ1ZmZlci5hbGxvYyhkYXRhTGF5b3V0LnNwYW4pO1xuICAgIGRhdGFMYXlvdXQuZW5jb2RlKFxuICAgICAge1xuICAgICAgICBpbnN0cnVjdGlvbjogMiwgLy8gQXBwbHlTaWduYXR1cmUgaW5zdHJ1Y3Rpb25cbiAgICAgIH0sXG4gICAgICBkYXRhLFxuICAgICk7XG5cbiAgICByZXR1cm4gbmV3IFRyYW5zYWN0aW9uKCkuYWRkKHtcbiAgICAgIGtleXM6IFtcbiAgICAgICAge3B1YmtleTogZnJvbSwgaXNTaWduZXI6IHRydWUsIGlzRGViaXRhYmxlOiB0cnVlfSxcbiAgICAgICAge3B1YmtleTogcHJvZ3JhbSwgaXNTaWduZXI6IGZhbHNlLCBpc0RlYml0YWJsZTogdHJ1ZX0sXG4gICAgICAgIHtwdWJrZXk6IHRvLCBpc1NpZ25lcjogZmFsc2UsIGlzRGViaXRhYmxlOiBmYWxzZX0sXG4gICAgICBdLFxuICAgICAgY29udHJvbGxlcklkOiB0aGlzLmNvbnRyb2xsZXJJZCxcbiAgICAgIGRhdGEsXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==