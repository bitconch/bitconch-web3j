{"version":3,"sources":["connection.js"],"names":["createRpcReq","url","server","request","callback","options","method","body","headers","res","text","args","Promise","resolve","reject","err","response","FetchBalanceRpcResult","jsonrpc","struct","literal","id","error","result","FetchReputationRpcResult","jsonRpcResult","resultDescription","jsonRpcVersion","union","AccountDetailResult","executable","owner","difs","reputations","data","fetchAccountDetailRpcResult","AccountNoticeResult","subscription","ControllerAccountDetailResult","ControllerAccountNoticeResult","ConfmTxnRpcResult","FetchRoundLeader","GetClusterNodes","list","pubkey","gossip","tpu","rpc","GetClusterNodes_015","GetEpochVoteAccounts","votePubkey","nodePubkey","stake","commission","FetchSignatureStateRpcResult","Ok","Err","FetchTxnAmountRpcResult","GetTotalSupplyRpcResult","FetchRecentBlockhash","difsPerSignature","maxDifsPerSignature","minDifsPerSignature","targetDifsPerSignature","targetSignaturesPerSlot","GetRecentBlockhash_015","ReqDroneRpcResult","ReqDrone1RpcResult","SendTxnRpcResult","Connection","endpoint","_rpcReq","href","_blockhashInfo","recentPackagehash","seconds","transactionSignatures","protocol","host","port","String","Number","_rpcWebSock","RpcWebSocketClient","autoconnect","max_reconnects","Infinity","on","_wsOnOpen","bind","_wsOnErr","_wsOnClose","_wsOnAccountNotice","_wsOnProgramAccountNotification","pubKey","toBase58","unsafeRes","Error","message","FetchBalance1RpcResult","PubKey","Buffer","from","signature","res_015","console","log","map","node","undefined","blockhash","feeCalculator","to","amount","transaction","signers","Date","getSeconds","sign","toString","includes","push","_disableBlockhashCaching","attempts","startTime","now","fetchRecentBlockhash","DEFAULT_TICKS_PER_SLOT","NUM_TICKS_PER_SEC","wireTransaction","serialize","sendNativeTxn","rawTransaction","_rpcWebSockConnected","_updateSubscriptions","code","accountKeys","Object","keys","_accountChangeSubscriptions","programKeys","_controllerAccountChangeSubscriptions","length","close","subscriptionId","connect","call","controllerId","notification","sub","_accountChangeSubscriptionCounter","accountId","fetchAccountDetail","_controllerAccountChangeSubscriptionCounter"],"mappings":"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","sourcesContent":["// @flow\n\nimport assert from 'assert';\nimport {parse as urlParse, format as urlFormat} from 'url';\nimport fetch from 'node-fetch';\nimport jayson from 'jayson/lib/client/browser';\nimport {struct} from 'superstruct';\nimport {Client as RpcWebSocketClient} from 'rpc-websockets';\n\nimport {DEFAULT_TICKS_PER_SLOT, NUM_TICKS_PER_SEC} from './timing';\nimport {PubKey} from './pubkey';\nimport {Transaction} from './transaction-controller';\nimport {sleep} from './util/sleep';\nimport type {Blockhash} from './bus-blockhash';\nimport type {FeeCalculator} from './fee-calculator';\nimport type {BusAccount} from './bus-account';\nimport type {TxnSignature} from './transaction-controller';\n\ntype RpcReq = (methodName: string, args: Array<any>) => any;\n\n/**\n * Information describing a cluster node\n *\n * @typedef {Object} NodeInfo\n * @property {string} pubkey Identity public key of the node\n * @property {string} gossip Gossip network address for the node\n * @property {string} tpu TPU network address for the node (null if not available)\n * @property {string|null} rpc JSON RPC network address for the node (null if not available)\n */\ntype NodeInfo = {\n  pubkey: string,\n  gossip: string,\n  tpu: string | null,\n  rpc: string | null,\n};\n\n/**\n * Information describing a vote account\n *\n * @typedef {Object} VoteAccountInfo\n * @property {string} votePubkey Public key of the vote account\n * @property {string} nodePubkey Identity public key of the node voting with this account\n * @property {string} stake The stake, in difs, delegated to this vote account\n * @property {string} commission A 32-bit integer used as a fraction (commission/0xFFFFFFFF) for rewards payout\n */\ntype VoteAccountInfo = {\n  votePubkey: string,\n  nodePubkey: string,\n  stake: number,\n  commission: number,\n};\n\nfunction createRpcReq(url): RpcReq {\n  const server = jayson(async (request, callback) => {\n    const options = {\n      method: 'POST',\n      body: request,\n      headers: {\n        'Content-Type': 'application/json',\n      },\n    };\n\n    try {\n      const res = await fetch(url, options);\n      const text = await res.text();\n      callback(null, text);\n    } catch (err) {\n      callback(err);\n    }\n  });\n\n  return (method, args) => {\n    return new Promise((resolve, reject) => {\n      server.request(method, args, (err, response) => {\n        if (err) {\n          reject(err);\n          return;\n        }\n        resolve(response);\n      });\n    });\n  };\n}\n\n/**\n * Expected JSON RPC response for the \"fetchAccountBalance\" message\n */\nconst FetchBalanceRpcResult = struct({\n  jsonrpc: struct.literal('2.0'),\n  id: 'string',\n  error: 'any?',\n  result: 'number?',\n});\n\nconst FetchReputationRpcResult = struct({\n  jsonrpc: struct.literal('2.0'),\n  id: 'string',\n  error: 'any?',\n  result: 'number?',\n});\n\n\n/**\n * @private\n */\nfunction jsonRpcResult(resultDescription: any) {\n  const jsonRpcVersion = struct.literal('2.0');\n  return struct.union([\n    struct({\n      jsonrpc: jsonRpcVersion,\n      id: 'string',\n      error: 'any',\n    }),\n    struct({\n      jsonrpc: jsonRpcVersion,\n      id: 'string',\n      error: 'null?',\n      result: resultDescription,\n    }),\n  ]);\n}\n\n/**\n * @private\n */\nconst AccountDetailResult = struct({\n  executable: 'boolean',\n  owner: 'array',\n  difs: 'number',\n  reputations: 'number',\n  data: 'array',\n});\n\n/**\n * Expected JSON RPC response for the \"fetchAccountDetail\" message\n */\nconst fetchAccountDetailRpcResult = jsonRpcResult(AccountDetailResult);\n\n/***\n * Expected JSON RPC response for the \"accountNotification\" message\n */\nconst AccountNoticeResult = struct({\n  subscription: 'number',\n  result: AccountDetailResult,\n});\n\n/**\n * @private\n */\nconst ControllerAccountDetailResult = struct(['string', AccountDetailResult]);\n\n/***\n * Expected JSON RPC response for the \"controllerNotification\" message\n */\nconst ControllerAccountNoticeResult = struct({\n  subscription: 'number',\n  result: ControllerAccountDetailResult,\n});\n\n/**\n * Expected JSON RPC response for the \"confmTxn\" message\n */\nconst ConfmTxnRpcResult = jsonRpcResult('boolean');\n\n/**\n * Expected JSON RPC response for the \"fetchRoundLeader\" message\n */\nconst FetchRoundLeader = jsonRpcResult('string');\n\n/**\n * Expected JSON RPC response for the \"fetchClusterNodes\" message\n */\nconst GetClusterNodes = jsonRpcResult(\n  struct.list([\n    struct({\n      pubkey: 'string',\n      gossip: 'string',\n      tpu: struct.union(['null', 'string']),\n      rpc: struct.union(['null', 'string']),\n    }),\n  ]),\n);\n/**\n * @ignore\n */\nconst GetClusterNodes_015 = jsonRpcResult(\n  struct.list([\n    struct({\n      id: 'string',\n      gossip: 'string',\n      tpu: struct.union(['null', 'string']),\n      rpc: struct.union(['null', 'string']),\n    }),\n  ]),\n);\n\n/**\n * Expected JSON RPC response for the \"getEpochVoteAccounts\" message\n */\nconst GetEpochVoteAccounts = jsonRpcResult(\n  struct.list([\n    struct({\n      votePubkey: 'string',\n      nodePubkey: 'string',\n      stake: 'number',\n      commission: 'number',\n    }),\n  ]),\n);\n\n/**\n * Expected JSON RPC response for the \"fetchSignatureState\" message\n */\nconst FetchSignatureStateRpcResult = jsonRpcResult(\n  struct.union([\n    'null',\n    struct.union([struct({Ok: 'null'}), struct({Err: 'object'})]),\n  ]),\n);\n\n/**\n * Expected JSON RPC response for the \"fetchTxnAmount\" message\n */\nconst FetchTxnAmountRpcResult = jsonRpcResult('number');\n\n/**\n * Expected JSON RPC response for the \"getTotalSupply\" message\n */\nconst GetTotalSupplyRpcResult = jsonRpcResult('number');\n\n/**\n * Expected JSON RPC response for the \"fetchRecentBlockhash\" message\n */\nconst FetchRecentBlockhash = jsonRpcResult([\n  'string',\n  struct({\n    difsPerSignature: 'number',\n    maxDifsPerSignature: 'number',\n    minDifsPerSignature: 'number',\n    targetDifsPerSignature: 'number',\n    targetSignaturesPerSlot: 'number',\n  }),\n]);\n/**\n * @ignore\n */\nconst GetRecentBlockhash_015 = jsonRpcResult([\n  'string',\n  struct({\n    difsPerSignature: 'number',\n  }),\n]);\n\n/**\n * Expected JSON RPC response for the \"reqDrone\" message\n */\nconst ReqDroneRpcResult = jsonRpcResult('string');\n\n/**\n * Expected JSON RPC response for the \"reqDrone1\" message\n */\nconst ReqDrone1RpcResult = jsonRpcResult('string');\n\n/**\n * Expected JSON RPC response for the \"sendTxn\" message\n */\nconst SendTxnRpcResult = jsonRpcResult('string');\n\n/**\n * Information describing an account\n *\n * @typedef {Object} AccountDetail\n * @property {number} difs Number of difs assigned to the account\n * @property {PubKey} owner Identifier of the controller that owns the account\n * @property {?Buffer} data Optional data assigned to the account\n * @property {boolean} executable `true` if this account's data contains a loaded controller\n */\ntype AccountDetail = {\n  executable: boolean,\n  owner: PubKey,\n  difs: number,\n  reputations: number,\n  data: Buffer,\n};\n\n/**\n * BusAccount information identified by pubkey\n *\n * @typedef {Object} KeyedAccountDetail\n * @property {PubKey} accountId\n * @property {AccountDetail} fetchAccountDetail\n */\ntype KeyedAccountDetail = {\n  accountId: PubKey,\n  fetchAccountDetail: AccountDetail,\n};\n\n/**\n * Callback function for account change notifications\n */\nexport type AccountChangeCallback = (fetchAccountDetail: AccountDetail) => void;\n\n/**\n * @private\n */\ntype AccountSubscriptionDetail = {\n  pubKey: string, // PubKey of the account as a base 58 string\n  callback: AccountChangeCallback,\n  subscriptionId: null | number, // null when there's no current server subscription id\n};\n\n/**\n * Callback function for controller account change notifications\n */\nexport type ControllerAccountChangeCallback = (\n  keyedAccountInfo: KeyedAccountDetail,\n) => void;\n\n/**\n * @private\n */\ntype ControllerAccountSubscriptionDetail = {\n  controllerId: string, // PubKey of the controller as a base 58 string\n  callback: ControllerAccountChangeCallback,\n  subscriptionId: null | number, // null when there's no current server subscription id\n};\n\n/**\n * Signature status: Success\n *\n * @typedef {Object} SignaturePass\n */\nexport type SignaturePass = {|\n  Ok: null,\n|};\n\n/**\n * Signature status: TxnErr\n *\n * @typedef {Object} TxnErr\n */\nexport type TxnErr = {|\n  Err: Object,\n|};\n\n/**\n * @ignore\n */\ntype BlockhashAndFeeCalculator = [Blockhash, FeeCalculator]; // This type exists to workaround an esdoc parse error\n\n/**\n * A connection to a fullnode JSON RPC endpoint\n */\nexport class Connection {\n  _rpcReq: RpcReq;\n  _rpcWebSock: RpcWebSocketClient;\n  _rpcWebSockConnected: boolean = false;\n\n  _blockhashInfo: {\n    recentPackagehash: Blockhash | null,\n    seconds: number,\n    transactionSignatures: Array<string>,\n  };\n  _disableBlockhashCaching: boolean = false;\n  _accountChangeSubscriptions: {[number]: AccountSubscriptionDetail} = {};\n  _accountChangeSubscriptionCounter: number = 0;\n  _controllerAccountChangeSubscriptions: {\n    [number]: ControllerAccountSubscriptionDetail,\n  } = {};\n  _controllerAccountChangeSubscriptionCounter: number = 0;\n\n  /**\n   * Establish a JSON RPC connection\n   *\n   * @param endpoint URL to the fullnode JSON RPC endpoint\n   */\n  constructor(endpoint: string) {\n    let url = urlParse(endpoint);\n\n    this._rpcReq = createRpcReq(url.href);\n    this._blockhashInfo = {\n      recentPackagehash: null,\n      seconds: -1,\n      transactionSignatures: [],\n    };\n\n    url.protocol = url.protocol === 'https:' ? 'wss:' : 'ws:';\n    url.host = '';\n    url.port = String(Number(url.port) + 1);\n    if (url.port === '1') {\n      url.port = url.protocol === 'wss:' ? '8901' : '8900';\n    }\n    this._rpcWebSock = new RpcWebSocketClient(urlFormat(url), {\n      autoconnect: false,\n      max_reconnects: Infinity,\n    });\n    this._rpcWebSock.on('open', this._wsOnOpen.bind(this));\n    this._rpcWebSock.on('error', this._wsOnErr.bind(this));\n    this._rpcWebSock.on('close', this._wsOnClose.bind(this));\n    this._rpcWebSock.on(\n      'accountNotification',\n      this._wsOnAccountNotice.bind(this),\n    );\n    this._rpcWebSock.on(\n      'controllerNotification',\n      this._wsOnProgramAccountNotification.bind(this),\n    );\n  }\n\n  /**\n   * Fetch the balance for the specified public key\n   */\n  async fetchAccountBalance(pubKey: PubKey): Promise<number> {\n    const unsafeRes = await this._rpcReq('getDif', [\n      pubKey.toBase58(),\n    ]);\n    const res = FetchBalanceRpcResult(unsafeRes);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n    assert(typeof res.result !== 'undefined');\n    return res.result;\n  }\n\n  async fetchAccountReputation(pubKey: PubKey): Promise<number> {\n    const unsafeRes = await this._rpcReq('getReputation', [\n      pubKey.toBase58(),\n    ]);\n    const res = FetchBalance1RpcResult(unsafeRes);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n    assert(typeof res.result !== 'undefined');\n    return res.result;\n  }\n\n  /**\n   * Fetch all the account info for the specified public key\n   */\n  async fetchAccountDetail(pubKey: PubKey): Promise<AccountDetail> {\n    const unsafeRes = await this._rpcReq('getAccountInfo', [\n      pubKey.toBase58(),\n    ]);\n    const res = fetchAccountDetailRpcResult(unsafeRes);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n\n    const {result} = res;\n    assert(typeof result !== 'undefined');\n\n    return {\n      executable: result.executable,\n      owner: new PubKey(result.owner),\n      difs: result.difs,\n      reputations: result.reputations,\n      data: Buffer.from(result.data),\n    };\n  }\n\n  /**\n   * Confirm the transaction identified by the specified signature\n   */\n  async confmTxn(signature: TxnSignature): Promise<boolean> {\n    const unsafeRes = await this._rpcReq('confirmTxn', [signature]);\n    const res = ConfmTxnRpcResult(unsafeRes);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n    assert(typeof res.result !== 'undefined');\n    return res.result;\n  }\n\n  /**\n   * Return the list of nodes that are currently participating in the cluster\n   */\n  async fetchClusterNodes(): Promise<Array<NodeInfo>> {\n    const unsafeRes = await this._rpcReq('getClusterNodes', []);\n\n    // Legacy v0.15 response.  TODO: Remove in August 2019\n    try {\n      const res_015 = GetClusterNodes_015(unsafeRes);\n      if (res_015.error) {\n        console.log('no', res_015.error);\n        throw new Error(res_015.error.message);\n      }\n      return res_015.result.map(node => {\n        node.pubkey = node.id;\n        node.id = undefined;\n        return node;\n      });\n    } catch (e) {\n      // Not legacy format\n    }\n    // End Legacy v0.15 response\n\n    const res = GetClusterNodes(unsafeRes);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n    assert(typeof res.result !== 'undefined');\n    return res.result;\n  }\n\n  /**\n   * Return the list of nodes that are currently participating in the cluster\n   */\n  async getEpochVoteAccounts(): Promise<Array<VoteAccountInfo>> {\n    const unsafeRes = await this._rpcReq('getEpochVoteAccounts', []);\n    const res = GetEpochVoteAccounts(unsafeRes);\n    //const res = unsafeRes;\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n    assert(typeof res.result !== 'undefined');\n    return res.result;\n  }\n\n  /**\n   * Fetch the current slot leader of the cluster\n   */\n  async fetchRoundLeader(): Promise<string> {\n    const unsafeRes = await this._rpcReq('getRoundLeader', []);\n    const res = FetchRoundLeader(unsafeRes);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n    assert(typeof res.result !== 'undefined');\n    return res.result;\n  }\n\n  /**\n   * Fetch the current transaction count of the cluster\n   */\n  async fetchSignatureState(\n    signature: TxnSignature,\n  ): Promise<SignaturePass | TxnErr | null> {\n    const unsafeRes = await this._rpcReq('getSignatureState', [signature]);\n    const res = FetchSignatureStateRpcResult(unsafeRes);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n    assert(typeof res.result !== 'undefined');\n    return res.result;\n  }\n\n  /**\n   * Fetch the current transaction count of the cluster\n   */\n  async fetchTxnAmount(): Promise<number> {\n    const unsafeRes = await this._rpcReq('getTxnCnt', []);\n    const res = FetchTxnAmountRpcResult(unsafeRes);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n    assert(typeof res.result !== 'undefined');\n    return Number(res.result);\n  }\n\n  /**\n   * Fetch the current total currency supply of the cluster\n   */\n  async getTotalSupply(): Promise<number> {\n    const unsafeRes = await this._rpcReq('getTotalSupply', []);\n    const res = GetTotalSupplyRpcResult(unsafeRes);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n    assert(typeof res.result !== 'undefined');\n    return Number(res.result);\n  }\n\n  /**\n   * Fetch a recent blockhash from the cluster\n   */\n  async fetchRecentBlockhash(): Promise<BlockhashAndFeeCalculator> {\n    const unsafeRes = await this._rpcReq('getLatestBlockhash', []);\n\n    // Legacy v0.15 response.  TODO: Remove in August 2019\n    try {\n      const res_015 = GetRecentBlockhash_015(unsafeRes);\n      if (res_015.error) {\n        throw new Error(res_015.error.message);\n      }\n      const [blockhash, feeCalculator] = res_015.result;\n      feeCalculator.targetSignaturesPerSlot = 42;\n      feeCalculator.targetDifsPerSignature =\n        feeCalculator.difsPerSignature;\n\n      return [blockhash, feeCalculator];\n    } catch (e) {\n      // Not legacy format\n    }\n    // End Legacy v0.15 response\n\n    const res = FetchRecentBlockhash(unsafeRes);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n    assert(typeof res.result !== 'undefined');\n    return res.result;\n  }\n\n  /**\n   * Request an allocation of difs to the specified account\n   */\n  async reqDrone(\n    to: PubKey,\n    amount: number,\n  ): Promise<TxnSignature> {\n    const unsafeRes = await this._rpcReq('requestDif', [\n      to.toBase58(),\n      amount,\n    ]);\n    const res = ReqDroneRpcResult(unsafeRes);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n    assert(typeof res.result !== 'undefined');\n    return res.result;\n  }\n\n    /**\n   * Request an allocation of reputations to the specified account\n   */\n  async reqDrone1(\n    to: PubKey,\n    amount: number,\n  ): Promise<TxnSignature> {\n    const unsafeRes = await this._rpcReq('requestDif1', [\n      to.toBase58(),\n      amount,\n    ]);\n    const res = ReqDrone1RpcResult(unsafeRes);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n    assert(typeof res.result !== 'undefined');\n    return res.result;\n  }\n\n  /**\n   * Sign and send a transaction\n   */\n  async sendTxn(\n    transaction: Transaction,\n    ...signers: Array<BusAccount>\n  ): Promise<TxnSignature> {\n    for (;;) {\n      // Attempt to use a recent blockhash for up to 30 seconds\n      const seconds = new Date().getSeconds();\n      if (\n        this._blockhashInfo.recentPackagehash != null &&\n        this._blockhashInfo.seconds < seconds + 30\n      ) {\n        transaction.recentPackagehash = this._blockhashInfo.recentPackagehash;\n        transaction.sign(...signers);\n        if (!transaction.signature) {\n          throw new Error('!signature'); // should never happen\n        }\n\n        // If the signature of this transaction has not been seen before with the\n        // current recentPackagehash, all done.\n        const signature = transaction.signature.toString();\n        if (!this._blockhashInfo.transactionSignatures.includes(signature)) {\n          this._blockhashInfo.transactionSignatures.push(signature);\n          if (this._disableBlockhashCaching) {\n            this._blockhashInfo.seconds = -1;\n          }\n          break;\n        }\n      }\n\n      // Fetch a new blockhash\n      let attempts = 0;\n      const startTime = Date.now();\n      for (;;) {\n        const [\n          recentPackagehash,\n          //feeCalculator,\n        ] = await this.fetchRecentBlockhash();\n\n        if (this._blockhashInfo.recentPackagehash != recentPackagehash) {\n          this._blockhashInfo = {\n            recentPackagehash,\n            seconds: new Date().getSeconds(),\n            transactionSignatures: [],\n          };\n          break;\n        }\n        if (attempts === 50) {\n          throw new Error(\n            `Unable to obtain a new blockhash after ${Date.now() -\n              startTime}ms`,\n          );\n        }\n\n        // Sleep for approximately half a slot\n        await sleep((500 * DEFAULT_TICKS_PER_SLOT) / NUM_TICKS_PER_SEC);\n\n        ++attempts;\n      }\n    }\n\n    const wireTransaction = transaction.serialize();\n    return await this.sendNativeTxn(wireTransaction);\n  }\n\n  /**\n   * @private\n   */\n  async fullnodeExit(): Promise<boolean> {\n    const unsafeRes = await this._rpcReq('fullnodeQuit', []);\n    const res = jsonRpcResult('boolean')(unsafeRes);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n    assert(typeof res.result !== 'undefined');\n    return res.result;\n  }\n\n  /**\n   * Send a transaction that has already been signed and serialized into the\n   * wire format\n   */\n  async sendNativeTxn(\n    rawTransaction: Buffer,\n  ): Promise<TxnSignature> {\n    const unsafeRes = await this._rpcReq('sendTxn', [\n      [...rawTransaction],\n    ]);\n    const res = SendTxnRpcResult(unsafeRes);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n    assert(typeof res.result !== 'undefined');\n    assert(res.result);\n    return res.result;\n  }\n\n  /**\n   * @private\n   */\n  _wsOnOpen() {\n    this._rpcWebSockConnected = true;\n    this._updateSubscriptions();\n  }\n\n  /**\n   * @private\n   */\n  _wsOnErr(err: Error) {\n    console.log('ws error:', err.message);\n  }\n\n  /**\n   * @private\n   */\n  _wsOnClose(code: number, message: string) {\n    // 1000 means _rpcWebSock.close() was called explicitly\n    if (code !== 1000) {\n      console.log('ws close:', code, message);\n    }\n    this._rpcWebSockConnected = false;\n  }\n\n  /**\n   * @private\n   */\n  async _updateSubscriptions() {\n    const accountKeys = Object.keys(this._accountChangeSubscriptions).map(\n      Number,\n    );\n    const programKeys = Object.keys(\n      this._controllerAccountChangeSubscriptions,\n    ).map(Number);\n    if (accountKeys.length === 0 && programKeys.length === 0) {\n      this._rpcWebSock.close();\n      return;\n    }\n\n    if (!this._rpcWebSockConnected) {\n      for (let id of accountKeys) {\n        this._accountChangeSubscriptions[id].subscriptionId = null;\n      }\n      for (let id of programKeys) {\n        this._controllerAccountChangeSubscriptions[id].subscriptionId = null;\n      }\n      this._rpcWebSock.connect();\n      return;\n    }\n\n    for (let id of accountKeys) {\n      const {subscriptionId, pubKey} = this._accountChangeSubscriptions[id];\n      if (subscriptionId === null) {\n        try {\n          this._accountChangeSubscriptions[\n            id\n          ].subscriptionId = await this._rpcWebSock.call('accountSubscribe', [\n            pubKey,\n          ]);\n        } catch (err) {\n          console.log(\n            `accountSubscribe error for ${pubKey}: ${err.message}`,\n          );\n        }\n      }\n    }\n    for (let id of programKeys) {\n      const {\n        subscriptionId,\n        controllerId,\n      } = this._controllerAccountChangeSubscriptions[id];\n      if (subscriptionId === null) {\n        try {\n          this._controllerAccountChangeSubscriptions[\n            id\n          ].subscriptionId = await this._rpcWebSock.call('programSubscribe', [\n            controllerId,\n          ]);\n        } catch (err) {\n          console.log(\n            `programSubscribe error for ${controllerId}: ${err.message}`,\n          );\n        }\n      }\n    }\n  }\n\n  /**\n   * @private\n   */\n  _wsOnAccountNotice(notification: Object) {\n    const res = AccountNoticeResult(notification);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n\n    const keys = Object.keys(this._accountChangeSubscriptions).map(Number);\n    for (let id of keys) {\n      const sub = this._accountChangeSubscriptions[id];\n      if (sub.subscriptionId === res.subscription) {\n        const {result} = res;\n        assert(typeof result !== 'undefined');\n\n        sub.callback({\n          executable: result.executable,\n          owner: new PubKey(result.owner),\n          difs: result.difs,\n          reputations: result.reputations,\n          data: Buffer.from(result.data),\n        });\n        return true;\n      }\n    }\n  }\n\n  /**\n   * Register a callback to be invoked whenever the specified account changes\n   *\n   * @param publickey Public key of the account to monitor\n   * @param callback Function to invoke whenever the account is changed\n   * @return subscription id\n   */\n  onAccountChange(\n    pubKey: PubKey,\n    callback: AccountChangeCallback,\n  ): number {\n    const id = ++this._accountChangeSubscriptionCounter;\n    this._accountChangeSubscriptions[id] = {\n      pubKey: pubKey.toBase58(),\n      callback,\n      subscriptionId: null,\n    };\n    this._updateSubscriptions();\n    return id;\n  }\n\n  /**\n   * Deregister an account notification callback\n   *\n   * @param id subscription id to deregister\n   */\n  async removeListenerOfAccountChange(id: number): Promise<void> {\n    if (this._accountChangeSubscriptions[id]) {\n      const {subscriptionId} = this._accountChangeSubscriptions[id];\n      delete this._accountChangeSubscriptions[id];\n      if (subscriptionId !== null) {\n        try {\n          await this._rpcWebSock.call('accountUnsubscribe', [subscriptionId]);\n        } catch (err) {\n          console.log('accountUnsubscribe error:', err.message);\n        }\n      }\n      this._updateSubscriptions();\n    } else {\n      throw new Error(`Unknown account change id: ${id}`);\n    }\n  }\n\n  /**\n   * @private\n   */\n  _wsOnProgramAccountNotification(notification: Object) {\n    const res = ControllerAccountNoticeResult(notification);\n    if (res.error) {\n      throw new Error(res.error.message);\n    }\n\n    const keys = Object.keys(this._controllerAccountChangeSubscriptions).map(\n      Number,\n    );\n    for (let id of keys) {\n      const sub = this._controllerAccountChangeSubscriptions[id];\n      if (sub.subscriptionId === res.subscription) {\n        const {result} = res;\n        assert(typeof result !== 'undefined');\n\n        sub.callback({\n          accountId: result[0],\n          fetchAccountDetail: {\n            executable: result[1].executable,\n            owner: new PubKey(result[1].owner),\n            difs: result[1].difs,\n            reputations: result[1].reputations,\n            data: Buffer.from(result[1].data),\n          },\n        });\n        return true;\n      }\n    }\n  }\n\n  /**\n   * Register a callback to be invoked whenever accounts owned by the\n   * specified controller change\n   *\n   * @param controllerId Public key of the controller to monitor\n   * @param callback Function to invoke whenever the account is changed\n   * @return subscription id\n   */\n  onControllerAccountChange(\n    controllerId: PubKey,\n    callback: ControllerAccountChangeCallback,\n  ): number {\n    const id = ++this._controllerAccountChangeSubscriptionCounter;\n    this._controllerAccountChangeSubscriptions[id] = {\n      controllerId: controllerId.toBase58(),\n      callback,\n      subscriptionId: null,\n    };\n    this._updateSubscriptions();\n    return id;\n  }\n\n  /**\n   * Deregister an account notification callback\n   *\n   * @param id subscription id to deregister\n   */\n  async removeControllerAccountChangeListener(id: number): Promise<void> {\n    if (this._controllerAccountChangeSubscriptions[id]) {\n      const {subscriptionId} = this._controllerAccountChangeSubscriptions[id];\n      delete this._controllerAccountChangeSubscriptions[id];\n      if (subscriptionId !== null) {\n        try {\n          await this._rpcWebSock.call('programUnsubscribe', [subscriptionId]);\n        } catch (err) {\n          console.log('programUnsubscribe error:', err.message);\n        }\n      }\n      this._updateSubscriptions();\n    } else {\n      throw new Error(`Unknown account change id: ${id}`);\n    }\n  }\n}\n"]}